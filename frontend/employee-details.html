<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/styles.css" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Employee Check-In Records</title>
  <style>
    select, input[type="number"] {
      font-size: 14px;
      padding: 4px 8px;
      height: 32px;
      width: auto;
      max-width: 160px;
      margin-right: 1rem;
      vertical-align: middle;
    }
    .summary {
      margin: 1rem 0;
    }
    .summary select {
      display: inline-block;
    }
    .summary p {
      margin: 0.25rem 0;
    }
  </style>
</head>
<body>
  <!-- üîù Sticky Navigation Bar -->
  <header class="top-nav">
    <img src="images/hubnetblack.jpg" alt="Logo" class="logo" />
    <h1>HUBNET Attendance</h1>
  </header>

  <div style="height: 24px;"></div>
  <h1 id="employeeName">Employee Logs</h1>

  <div class="summary" style="display: flex; flex-wrap: wrap; align-items: center; gap: 1rem;">
    <label style="display: inline-block; max-width: 160px; margin-right: 1rem;">
      Start Date:
      <input type="date" id="startDate" style="font-size: 14px; padding: 4px 8px; height: 32px; width: 100%;" />
    </label>
    <label style="display: inline-block; max-width: 160px; margin-right: 1rem;">
      End Date:
      <input type="date" id="endDate" style="font-size: 14px; padding: 4px 8px; height: 32px; width: 100%;" />
    </label>
    <select id="yearFilter"></select>
    <select id="monthFilter"></select>
    <button class="btn" onclick="resetFilters()">Clear All</button>
  </div>

  <div class="summary">
    <p>Total Sessions: 
   <strong id="sessionCount">0</strong></p>
    <p>Total Overtime: <span id="overtimeCount">0h 0m</span></p>
    <p>Paid Leave Remaining: <strong id="leaveBalance">-</strong></p>
  </div>

  <a href="employees.html" class="btn">‚Üê Back to Employee List</a>
  <a href="admin.html" class="btn">Back to Admin Dashboard</a>

<!-- üîÅ Weekly Shift Pattern Modal -->
<div style="margin: 1rem 0;">
  <button class="btn" onclick="openWeeklyShiftModal()">+ Set Weekly Shift</button>
</div>

<div id="weeklyShiftModal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); background:white; padding:1.5rem; box-shadow:0 0 12px rgba(0,0,0,0.2); border-radius:8px; z-index:999;">
  <h3>Set Weekly Shift for <span id="modalEmployeeName"></span></h3>
  <label>Day of Week:
    <select id="weeklyShiftDay" required>
      <option value="monday">Monday</option>
      <option value="tuesday">Tuesday</option>
      <option value="wednesday">Wednesday</option>
      <option value="thursday">Thursday</option>
      <option value="friday">Friday</option>
      <option value="saturday">Saturday</option>
      <option value="sunday">Sunday</option>
    </select>
  </label><br><br>
  <label>Start Time:
    <input type="time" id="weeklyShiftStart" required>
  </label><br><br>
  <label>End Time:
    <input type="time" id="weeklyShiftEnd" required>
  </label><br><br>
  <button class="btn" onclick="submitWeeklyShift()">Save</button>
  <button class="btn" onclick="closeWeeklyShiftModal()">Cancel</button>
</div>

  <table>
    <thead>
      <tr>
        <th>Check-In</th>
        <th>Check-Out</th>
        <th>Worked Time</th>
        <th>Overtime</th>
        <th>Type</th>
        <th>Hours Used</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="logTable"></tbody>
  </table>

  <script>
    const params = new URLSearchParams(window.location.search);
    const employeeName = params.get('name');
    document.getElementById('employeeName').textContent = `Logs for: ${employeeName}`;

    let allRecords = [];

    fetch('/api/sessions/all')
      .then(res => res.json())
      .then(data => {
        allRecords = data.filter(e => e.name === employeeName && e.checkIn && e.checkOut);
        populateYearMonthFilters(allRecords);
        applyFilterAndRender();

        return fetch(`/api/users/${encodeURIComponent(employeeName)}/leave-balance`);
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById('leaveBalance').textContent = data.formatted || '0d 0h';
      })
      .catch(err => {
        console.error('[Leave Balance Fetch Error]', err);
        document.getElementById('leaveBalance').textContent = '-';
     });

    function toLocalDatetimeString(dateStr) {
      const date = new Date(dateStr);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
    }

    function toISOStringLocal(datetimeStr) {
      return new Date(datetimeStr).toISOString();
    }

    function populateYearMonthFilters(records) {
      const yearSet = new Set();
      const monthSet = new Set();

      records.forEach(r => {
        const date = new Date(r.checkIn);
        yearSet.add(date.getFullYear());
        monthSet.add(date.getMonth());
      });

      const yearSelect = document.getElementById('yearFilter');
      const monthSelect = document.getElementById('monthFilter');
      const monthNames = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
      ];

      yearSelect.innerHTML = `<option value="">All Years</option>` +
        [...yearSet].sort((a, b) => b - a).map(y => `<option value="${y}">${y}</option>`).join('');

      monthSelect.innerHTML = `<option value="">All Months</option>` +
        [...monthSet].sort((a, b) => a - b)
          .map(m => `<option value="${m}">${monthNames[m]}</option>`)
          .join('');

      yearSelect.addEventListener('change', applyFilterAndRender);
      monthSelect.addEventListener('change', applyFilterAndRender);
  document.getElementById('startDate')?.addEventListener('change', applyFilterAndRender);
  document.getElementById('endDate')?.addEventListener('change', applyFilterAndRender);
    }

    function applyFilterAndRender() {
      const year = document.getElementById('yearFilter').value;
      const month = document.getElementById('monthFilter').value;
      const startDateVal = document.getElementById('startDate')?.value;
      const endDateVal = document.getElementById('endDate')?.value;
      const startDate = startDateVal ? new Date(startDateVal) : null;
      const endDate = endDateVal ? new Date(new Date(endDateVal).setHours(23, 59, 59, 999)) : null;

      const filtered = allRecords.filter(entry => {
        const d = new Date(entry.checkIn);
        const matchYear = !year || d.getFullYear().toString() === year;
        const matchMonth = month === '' || d.getMonth().toString() === month;
        const matchStart = !startDate || d >= startDate;
        const matchEnd = !endDate || d <= endDate;
        return matchYear && matchMonth && matchStart && matchEnd;
      });

      renderLogTable(filtered);
    }

    function renderLogTable(records) {
      const tbody = document.getElementById('logTable');
      tbody.innerHTML = '';
      document.getElementById('sessionCount').textContent = records.length;

      let totalOvertimeMinutes = 0;

      records.forEach(entry => {
        const checkIn = new Date(entry.checkIn);
        const checkOut = new Date(entry.checkOut);
        const workedMs = checkOut - checkIn;
        const totalMinutes = Math.max(0, Math.round(workedMs / 60000));
        const adjustedWorked = totalMinutes > 360 ? totalMinutes - 60 : totalMinutes;
        let workedTime = '-';
        let hours = 0;
        let minutes = 0;
        if (entry.type === 'work') {
          hours = Math.floor(adjustedWorked / 60);
          minutes = adjustedWorked % 60;
          workedTime = adjustedWorked > 0 ? `${hours}h ${minutes}m` : '-';
        }
        let overtimeMinutes = 0;
        let overtime = '-';
        if (entry.type === 'work') {
          overtimeMinutes = Math.max(0, adjustedWorked - 480);
          overtime = overtimeMinutes > 0 ? `${Math.floor(overtimeMinutes / 60)}h ${overtimeMinutes % 60}m` : '-';
        }

        if (overtimeMinutes > 0) totalOvertimeMinutes += overtimeMinutes;

        const row = document.createElement('tr');
        const checkInValue = toLocalDatetimeString(entry.checkIn);
        const checkOutValue = toLocalDatetimeString(entry.checkOut);

        row.innerHTML = `
          <td><input type="datetime-local" value="${checkInValue}" data-id="${entry._id}" data-type="checkIn" disabled></td>
          <td><input type="datetime-local" value="${checkOutValue}" data-id="${entry._id}" data-type="checkOut" disabled></td>
          <td>${workedTime}</td>
          <td>${overtime}</td>
          <td>
            <select data-id="${entry._id}" data-type="type" disabled>
              <option value="work" ${entry.type === 'work' ? 'selected' : ''}>Work</option>
              <option value="paid_leave" ${entry.type === 'paid_leave' ? 'selected' : ''}>Paid Leave</option>
              <option value="unpaid_leave" ${entry.type === 'unpaid_leave' ? 'selected' : ''}>Unpaid Leave</option>
            </select>
          </td>
          <td>
            ${
              (entry.type === 'paid_leave' || entry.type === 'unpaid_leave') ?
              (() => {
                const ms = new Date(entry.checkOut) - new Date(entry.checkIn);
                const fullDays = Math.floor(ms / (1000 * 60 * 60 * 24));
                const leftoverMs = ms % (1000 * 60 * 60 * 24);
                const leftoverHours = Math.round((leftoverMs / (1000 * 60 * 60)) * 2) / 2;
                return `<input type="text" value="${fullDays}d ${leftoverHours}h" disabled readonly>`;
              })() : ''
            }
          </td>
          </td>
          <td>
            
            <button class="btn edit-btn" onclick="enableEdit('${entry._id}', this)">‚úèÔ∏è Edit</button>
            <button class="btn save-btn" onclick="saveSession('${entry._id}')" style="display:none;">üìÇ Save</button>
            <button class="btn delete-btn" onclick="deleteSession('${entry._id}')">üóëÔ∏è Delete</button>
          </td>
        `;

        tbody.appendChild(row);
      });

      const totalOvertime = `${Math.floor(totalOvertimeMinutes / 60)}h ${totalOvertimeMinutes % 60}m`;
      document.getElementById('overtimeCount').textContent = totalOvertime;
    }

    window.enableEdit = function (sessionId, button) {
      const row = button.closest('tr');
      row.querySelectorAll('input, select').forEach(input => input.disabled = false);
      row.querySelector('.save-btn').style.display = 'inline-flex';
      button.style.display = 'none';
    }

    window.saveSession = async function (sessionId) {
      const checkInInput = document.querySelector(`input[data-id='${sessionId}'][data-type='checkIn']`);
      const checkOutInput = document.querySelector(`input[data-id='${sessionId}'][data-type='checkOut']`);
      const typeSelect = document.querySelector(`select[data-id='${sessionId}'][data-type='type']`);

      const body = {
        checkIn: toISOStringLocal(checkInInput.value),
        checkOut: toISOStringLocal(checkOutInput.value),
        type: typeSelect.value,
        
      };

      try {
        const res = await fetch(`/api/sessions/${sessionId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const result = await res.json();
        if (result.success) {
          alert('‚úÖ Session updated!');
          const refreshed = await fetch('/api/sessions/all').then(res => res.json());
          allRecords = refreshed.filter(e => e.name === employeeName && e.checkIn && e.checkOut);
          applyFilterAndRender();
        } else {
          alert('‚ùå Failed to update session.');
        }
      } catch (err) {
        console.error('Session update error:', err);
        alert('‚ùå Request failed.');
      }
    };
  window.deleteSession = async function (sessionId) {
  if (!confirm('Are you sure you want to delete this session?')) return;
  try {
    const res = await fetch(`/api/sessions/${sessionId}`, { method: 'DELETE' });
    const result = await res.json();
    if (result.success) {
      alert('üóëÔ∏è Session deleted.');
      const refreshed = await fetch('/api/sessions/all').then(res => res.json());
      allRecords = refreshed.filter(e => e.name === employeeName && e.checkIn && e.checkOut);
      applyFilterAndRender();
    } else {
      alert('‚ùå Failed to delete session.');
    }
  } catch (err) {
    console.error('Session delete error:', err);
    alert('‚ùå Request failed.');
  }
};
function resetFilters() {
  document.getElementById('yearFilter').value = '';
  document.getElementById('monthFilter').value = '';
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  applyFilterAndRender();
}

function openWeeklyShiftModal() {
  document.getElementById('modalEmployeeName').textContent = employeeName;
  document.getElementById('weeklyShiftDay').value = 'monday';
  document.getElementById('weeklyShiftStart').value = '';
  document.getElementById('weeklyShiftEnd').value = '';
  document.getElementById('weeklyShiftModal').style.display = 'block';
}

function closeWeeklyShiftModal() {
  document.getElementById('weeklyShiftModal').style.display = 'none';
}

async function submitWeeklyShift() {
  const day = document.getElementById('weeklyShiftDay').value;
  const start = document.getElementById('weeklyShiftStart').value;
  const end = document.getElementById('weeklyShiftEnd').value;

  if (!day || !start || !end) {
    alert("‚ùå Please fill in all fields.");
    return;
  }

  const shiftTime = `${start}-${end}`;
  const body = {
    customSchedule: {
      [day]: { time: shiftTime }
    }
  };

  try {
    const res = await fetch(`/api/users/${encodeURIComponent(employeeName)}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    const result = await res.json();
    if (result.success) {
      alert(`‚úÖ Weekly shift for ${day} saved!`);
      closeWeeklyShiftModal();
    } else {
      alert('‚ùå Failed to save weekly shift.');
    }
  } catch (err) {
    console.error(err);
    alert('‚ùå Request failed.');
  }
}
</script>
</body>
</html>
